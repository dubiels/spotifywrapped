{% extends 'base.html' %}

{% block content %}
<div class="container py-5" class="dark:bg-black dark:text-white" style="background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); color: white;">
  <!-- Header Section -->
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold">{{ user.first_name }}'s Wrapped</h1>
    <p class="text-light">Discover your top songs, artists, and genres!</p>
  </div>

  <!-- Top Songs and Artists Section -->
  <div class="row mb-5">
    <!-- Top Songs -->
    <div class="col-md-6">
      <h2 class="text-center mb-4">Top Songs</h2>
      <div
        id="topSongsCarousel"
        class="carousel slide carousel-fade position-relative shadow"
        data-bs-ride="carousel"
        style="width: 320px; height: 320px; margin: 0 auto; border-radius: 10px; overflow: hidden;"
      >
        <div class="carousel-inner h-100 w-100">
          {% for track in top_tracks %}
          <div class="carousel-item {% if forloop.first %}active{% endif %} h-100 w-100">
            <div class="position-relative h-100 w-100">
              <img
                src="{{ track.album_cover_url }}"
                alt="{{ track.album }}"
                class="d-block w-100 h-100"
                style="object-fit: cover; filter: brightness(0.7);"
              />
              <div class="carousel-caption d-flex flex-column align-items-center justify-content-center">
                <h5 class="text-white fw-bold">{{ track.name }}</h5>
                <p class="text-light">{{ track.artist }}</p>
                {% if track.preview_url %}
                <button
                  onclick="playPreview(this, '{{ track.preview_url }}')"
                  class="btn btn-outline-light btn-sm"
                  style="backdrop-filter: blur(5px);"
                >
                  ▶ Play Preview
                </button>
                {% else %}
                <p class="text-muted mb-0">No preview available</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <p class="text-center text-light">No top songs available.</p>
          {% endfor %}
        </div>
        <button
          class="carousel-control-prev btn btn-dark rounded-circle d-flex align-items-center justify-content-center"
          type="button"
          data-bs-target="#topSongsCarousel"
          data-bs-slide="prev"
          style="
            z-index: 15;
            width: 50px; /* Circular width */
            height: 50px; /* Circular height */
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust vertical centering */
          "
        >
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button
          class="carousel-control-next btn btn-dark rounded-circle d-flex align-items-center justify-content-center"
          type="button"
          data-bs-target="#topSongsCarousel"
          data-bs-slide="next"
          style="
            z-index: 15;
            width: 50px; /* Circular width */
            height: 50px; /* Circular height */
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust vertical centering */
          "
        >
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>
    </div>

    <!-- Top Artists -->
    <div class="col-md-6">
      <h2 class="text-center mb-4">Top Artists</h2>
      <div
        id="topArtistsCarousel"
        class="carousel slide carousel-fade position-relative shadow"
        data-bs-ride="carousel"
        style="width: 320px; height: 320px; margin: 0 auto; border-radius: 10px; overflow: hidden;"
      >
        <div class="carousel-inner h-100 w-100">
          {% for artist in top_artists %}
          <div class="carousel-item {% if forloop.first %}active{% endif %} h-100 w-100">
            <div class="position-relative h-100 w-100">
              {% if artist.image_url %}
              <img
                src="{{ artist.image_url }}"
                alt="{{ artist.name }}"
                class="d-block w-100 h-100"
                style="object-fit: cover; filter: brightness(0.7);"
              />
              {% else %}
              <div
                class="d-flex align-items-center justify-content-center h-100 w-100 bg-secondary text-white"
              >
                <span class="fs-3">{{ artist.name|first|upper }}</span>
              </div>
              {% endif %}
              <div class="carousel-caption d-flex flex-column align-items-center justify-content-center">
                <h5 class="text-white fw-bold">{{ artist.name }}</h5>
              </div>
            </div>
          </div>
          {% empty %}
          <p class="text-center text-light">No top artists available.</p>
          {% endfor %}
        </div>
        <button
          class="carousel-control-prev btn btn-dark rounded-circle d-flex align-items-center justify-content-center"
          type="button"
          data-bs-target="#topArtistsCarousel"
          data-bs-slide="prev"
          style="
            z-index: 15;
            width: 50px; /* Circular width */
            height: 50px; /* Circular height */
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust vertical centering */
          "
        >
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button
          class="carousel-control-next btn btn-dark rounded-circle d-flex align-items-center justify-content-center"
          type="button"
          data-bs-target="#topArtistsCarousel"
          data-bs-slide="next"
          style="
            z-index: 15;
            width: 50px; /* Circular width */
            height: 50px; /* Circular height */
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust vertical centering */
          "
        >
          <span class="carousel-control-next-icon"></span>
        </button>

          <span class="carousel-control-next-icon"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Top Genres Section -->
  <section class="py-5">
    <h2 class="text-center mb-4 fw-bold text-white">Top Genres</h2>
    <div
      id="topGenresCarousel"
      class="carousel slide carousel-fade position-relative"
      data-bs-ride="carousel"
      style="width: 300px; height: 150px; margin: 0 auto; border-radius: 10px; overflow: hidden;"
    >
      <div class="carousel-inner h-100 w-100">
        {% for genre in top_genres %}
        <div class="carousel-item {% if forloop.first %}active{% endif %} h-100 w-100">
          <div
            class="position-relative h-100 w-100"
            style="
              border-radius: 10px;
              box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.2);
            "
          >
            <!-- Background with Brightness -->
            <div
              class="h-100 w-100 position-absolute"
              style="
                background: linear-gradient(135deg, #b4eefd, #d8b5ff);
                filter: brightness(0.7);
                z-index: 1;
              "
            ></div>
            <!-- Genre Caption -->
            <div
              class="d-flex flex-column justify-content-center align-items-center h-100 w-100 position-relative"
              style="z-index: 2; text-align: center;"
            >
              <h5
                class="text-white fw-bold mb-0"
                style="font-size: 1.5rem;"
              >
                {{ genre }}
              </h5>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-center text-muted">No top genres available.</p>
        {% endfor %}
      </div>
      <button
        class="carousel-control-prev btn btn-dark rounded-circle p-2"
        type="button"
        data-bs-target="#topGenresCarousel"
        data-bs-slide="prev"
        style="z-index: 15; width: 30px; height: 30px; top: 50%; transform: translateY(-50%);"
      >
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button
        class="carousel-control-next btn btn-dark rounded-circle p-2"
        type="button"
        data-bs-target="#topGenresCarousel"
        data-bs-slide="next"
        style="z-index: 15; width: 30px; height: 30px; top: 50%; transform: translateY(-50%);"
      >
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </section>

</div>

<script>
  let audio = null;
  let currentlyPlayingButton = null;

  function playPreview(button, previewUrl) {
    if (audio && audio.src === previewUrl) {
      audio.paused ? audio.play() : audio.pause();
      button.innerText = audio.paused ? "▶" : "❚❚";
    } else {
      if (audio) audio.pause();
      audio = new Audio(previewUrl);
      audio.play();
      button.innerText = "❚❚";
      currentlyPlayingButton = button;
      audio.onended = () => {
        button.innerText = "▶";
        currentlyPlayingButton = null;
      };
    }
  }
</script>
{% endblock %}

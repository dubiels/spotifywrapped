{% extends 'base.html' %} {% block content %}
<div class="w-full min-h-screen bg-[111111] text-white px-[10vw] py-10">
  <!-- Header Section -->
  <div class="text-center mb-8">
    <h1 class="text-8xl font-bold">{{ user.first_name}}'s Wrapped</h1>
    <div class="flex justify-center items-center mt-4 space-x-2">
      
      <form method="POST">
        {% csrf_token %}
          <span class="text-lg">Name your wrap:</span>
          <input class="text-black" id="new_wrap_name" name="new_wrap_name" placeholder="Type here.."></input>
          <span class="text-lg">Time period:</span>
          <select
            id="timeframe_select"
            name="timeframe_select"
            class="bg-black text-gray-400 border border-gray-600 rounded p-1 focus:ring-2 focus:ring-green-500"
          >
            <option value="short_term">Last 4 Weeks</option>
            <option value="medium_term" selected>Last 6 Months</option>
            <option value="long_term">All Time</option>
          </select>
          <button id="create-button" type="submit" class="bg-green-500 text-white font-semibold py-1 px-4 rounded-full hover:bg-green-600 transition">Create</button>
      </form>
    </div>
  </div>

  <!-- Two-column layout -->
  <divt
    class="flex flex-col md:flex-row justify-between space-y-8 md:space-y-0 md:space-x-8"
  >
    <!-- Top Songs Column (Left) -->
    <section class="w-full md:w-2/3">
      <h2 class="text-2xl font-semibold mb-4 text-center">Top songs:</h2>
      <script src="https://sdk.scdn.co/spotify-player.js"></script>
      <div class="bg-gray-900 p-6 rounded-lg">
        <ul id="top-tracks-list">
          {% for track in top_tracks %}
          <li
            class="flex items-center justify-between py-4 border-b border-gray-700"
          >
            <div class="flex items-center space-x-4">
              {% if track.album_cover_url %}
              <img
                src="{{ track.album_cover_url }}"
                alt="{{ track.album }}"
                class="w-12 h-12 rounded object-cover"
              />
              {% else %}
              <div
                class="w-12 h-12 rounded bg-gray-700 flex items-center justify-center text-white"
              >
                {{ track.name|first|upper }}
              </div>
              {% endif %}
              <div>
                <div class="text-lg font-semibold">{{ track.name }}</div>
                <div class="text-gray-400">{{ track.artist }}</div>
              </div>
            </div>
            <div class="flex items-center">
              <div class="text-gray-400 text-sm mr-4">{{ track.album }}</div>
              {% if track.preview_url %}
              <button
    id="play-pause-button-{{ track.id }}"
    onclick="playPreview(this, '{{ track.preview_url }}')"
    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full"
>
▶
</button>
              {% else %}
              <span class="text-gray-500">No preview available</span>
              {% endif %}
            </div>
          </li>
          {% empty %}
          <p class="text-gray-500">No top songs available.</p>
          {% endfor %}
        </ul>
      </div>
    </section>

    <!-- Top Artists Column (Right) -->
    <section class="w-full md:w-1/3">
      <h2 class="text-2xl font-semibold mb-4 text-center">Top artists:</h2>
      {% if top_artists %}
      <div class="grid grid-cols-2 gap-x-0 gap-y-10">
        {% for artist in top_artists %}
        <div class="text-center">
          {% if artist.image_url %}
          <img
            src="{{ artist.image_url }}"
            alt="{{ artist.name }}"
            class="w-40 h-40 rounded-full mx-auto object-cover"
          />
          {% else %}
          <div
            class="w-40 h-40 rounded-full bg-gray-700 flex items-center justify-center text-white mx-auto"
          >
            {{ artist.name|first|upper }}
          </div>
          {% endif %}
          <div class="mt-2 text-white font-medium">{{ artist.name }}</div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-gray-500 text-center">No top artists available.</p>
      {% endif %}
    </section>
  </div>

  <!-- Top Genres Section -->
  <section class="mt-10">
    <h2 class="text-2xl font-semibold mb-4 text-center">Top genres:</h2>
    <div class="flex justify-center space-x-4 flex-wrap">
      {% for genre in top_genres %}
      <div class="bg-gray-800 text-white rounded-full px-4 py-2 m-2 genre">
        {{ genre }}
      </div>
      {% empty %}
      <p class="text-gray-500">No top genres available.</p>
      {% endfor %}
    </div>
  </section>



  <section class="wrapper-section">
    <h2 class="section-title">{{ user.first_name }}'s Generated Wrapped</h2>
    <div class="wrap-grid">
      {% for wrap in wraps %}
        <div class="wrap-card">
          <h1 class="wrap-title">{{ wrap.overview.title }}</h1>
          <h2 class="wrap-date">{{ wrap.overview.created_at }}</h2>
          <div class="wrap-content">
            <h3 class="content-heading">Top Tracks:</h3>
            <ul class="track-list">
              {% for track in wrap.top_tracks %}
                <li>{{ track.name }}, {{ track.artist }}</li>
              {% endfor %}
            </ul>
            <h3 class="content-heading">Top Artists:</h3>
            <ul class="artist-list">
              {% for artist in wrap.top_artists %}
                <li>{{ artist.name }}</li>
              {% endfor %}
            </ul>
            <h3 class="content-heading">Top Genres:</h3>
            <ul class="genre-list"></ul>
            {% for genre in top_genres %}
              {{ genre }}
              {% endfor %}
              </ul>
          </div>
        </div>
      {% empty %}
      <p class="no-wraps-message">No wraps available.</p>
      {% endfor %}
    </div>
  </section>
  

  <section class="mt-10"></section>
    <h2 class="text-2xl font-semibold mb-4 text-center">User's Friends</h2>
    <form method="POST" action="#">
      {% csrf_token %}
      <input class="text-black" id="friend_name" name="friend_name" autocomplete="off">
      </input>
      <button type="submit" class="bg-green-500 text-white font-semibold py-1 px-4 rounded-full hover:bg-green-600 transition">
        Add Friend +
      </button>
    </form>
    <div class="flex justify-center space-x-4 flex-wrap"></div>
      {% for friend in friends %}
      <div class="bg-gray-800 text-white rounded-full px-4 py-2 m-2">
        {{ friend }}
      </div>
      {% empty %}
      <p class="text-gray-500">You have no friends</p>
      {% endfor %}

      {% if invalid_username %}
      You provided an invalid username
      {% else %}

      {% endif %}
    </div>
  </section>
</div>

<script>
  document.getElementById('timeframe_select').addEventListener('change', function() {
      const timeFrame = this.value;
      fetch(`/fetch_top_tracks/?time_frame=${timeFrame}`)
          .then(response => response.json())
          .then(data => {
              const topTracksList = document.getElementById('top-tracks-list');
              topTracksList.innerHTML = ''; // Clear existing tracks
              if (data.top_tracks && data.top_tracks.length > 0) {
                  data.top_tracks.forEach(track => {
                      const listItem = document.createElement('li');
                      listItem.className = 'flex items-center justify-between py-4 border-b border-gray-700';
                      listItem.innerHTML = `
                          <div class="flex items-center space-x-4">
                              ${track.album_cover_url 
                                  ? `<img src="${track.album_cover_url}" alt="${track.album}" class="w-12 h-12 rounded object-cover">`
                                  : `<div class="w-12 h-12 rounded bg-gray-700 flex items-center justify-center text-white">
                                      ${track.name.charAt(0).toUpperCase()}
                                     </div>`
                              }
                              <div>
                                  <div class="text-lg font-semibold">${track.name}</div>
                                  <div class="text-gray-400">${track.artist}</div>
                              </div>
                          </div>
                          <div class="flex items-center">
                              <div class="text-gray-400 text-sm mr-4">${track.album}</div>
                              ${track.preview_url 
                                  ? `<button onclick="playPreview('${track.preview_url}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">
                                      ▷
                                     </button>`
                                  : `<span class="text-gray-500">No preview available</span>`
                              }
                          </div>
                      `;
                      topTracksList.appendChild(listItem);
                  });
              } else {
                  topTracksList.innerHTML = '<li class="text-gray-500">No top tracks available.</li>';
              }
          })
          .catch(error => console.error('Error fetching top tracks:', error));
  });
  
  
  let audio = null;
let currentlyPlayingButton = null;

function playPreview(button, previewUrl) {
    // Check if the audio is already playing and if it's the same URL
    if (audio && audio.src === previewUrl) {
        if (audio.paused) {
            audio.play();
            button.innerText = "❚❚"; // Change to pause icon
        } else {
            audio.pause();
            button.innerText = "▶"; // Change back to play icon
        }
    } else {
        // Pause any existing audio and reset the button
        if (audio) {
            audio.pause();
            if (currentlyPlayingButton) {
                currentlyPlayingButton.innerText = "▶"; // Reset previous buttons to play icon
            }
        }
        
        // Set the new audio and play it
        audio = new Audio(previewUrl);
        audio.play();
        
        // Update the button icons
        button.innerText = "❚❚"; // Change to pause icon
        currentlyPlayingButton = button;

        // Reset icon when audio ends
        audio.onended = () => {
            button.innerText = "▶";
            currentlyPlayingButton = null;
        };
    }
}

  </script>

{% endblock %}